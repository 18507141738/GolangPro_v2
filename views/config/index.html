<!DOCTYPE html><html><head>    <meta charset="utf-8" />    <meta http-equiv="X-UA-Compatible" content="IE=edge" />    <title>{{.SystemTitle}}</title>    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">    <link rel="stylesheet" href="/static/layui/css/layui.css" /></head><script src="/static/js/common.js"></script><body class="layui-layout-body"><div class="layui-layout layui-layout-admin">    <!-- TOP -->    <div class="layui-header">        <div class="layui-logo">{{.SystemTitle}}</div>        <!-- 头部区域（可配合layui已有的水平导航） -->        <ul class="layui-nav layui-layout-right">            <li class="layui-nav-item">                <a href="javascript:;">                    <i class="layui-icon layui-icon-username"></i>&nbsp;{{.admin_name}}                </a>                <dl class="layui-nav-child">                    <dd>                        <a href="javascript:logout()">退出登录</a>                    </dd>                </dl>            </li>        </ul>    </div>    <div class="layui-side layui-bg-black" id="leftNav">        <div class="layui-side-scroll">            <!-- 左侧菜单 -->            <ul class="layui-nav layui-nav-tree" lay-filter="test">                <li class="layui-nav-item layui-nav-itemed">                    <a href="javascript:;">系统设置</a>                    <dl class="layui-nav-child">                        <dd class="layui-this"><a href="javascript:;" tab_id="1000" data-url="/set/sys_set">系统设置</a></dd>                        <dd>                            <a href="javascript:;" tab_id="1001" data-url="/set/host_manager">分析主机管理</a>                        </dd>                    </dl>                </li>                <li class="layui-nav-item layui-nav-itemed">                    <a href="javascript:;">区域管理</a>                    <dl class="layui-nav-child">                        <dd>                            <a href="javascript:;" tab_id="1002" data-url="/set/location_manager">区域管理</a>                        </dd>                    </dl>                </li>                <li class="layui-nav-item layui-nav-itemed">                    <a href="javascript:;">组织管理</a>                    <dl class="layui-nav-child">                        <dd>                            <a href="javascript:;" tab_id="1004" data-url="/set/organization">组织管理</a>                        </dd>                        <dd>                            <a href="javascript:;" tab_id="1005" data-url="/set/permissions_page">处置权限</a>                        </dd>                    </dl>                </li>                <li class="layui-nav-item layui-nav-itemed">                    <a href="javascript:;">报警管理</a>                    <dl class="layui-nav-child">                        <dd>                            <a href="javascript:;" tab_id="1003" lay-id="1003" data-url="/set/alarm">报警列表</a>                        </dd>                    </dl>                </li>            </ul>        </div>    </div>    <!-- CONTENT -->    <div class="layui-body">        <input type="hidden" id="txt1" value="" />        <!-- 内容主体区域 -->        <div style="width: 100%;height: 100%;">            <div class="layui-tab" lay-filter="mytab" lay-allowClose="true" id="1000"  style="margin: 0;padding: 5px;">                <ul class="layui-tab-title">                    <li class="layui-this" lay-id="1000">                        <cite>系统设置</cite>                    </li>                </ul>                <div class="layui-tab-content" style="border: none">                    <div class="layui-tab-item layui-show">                        <iframe id='myframe' src="/set/sys_set" frameborder="0" width="100%" height="100%"></iframe>                    </div>                </div>            </div>        </div>    </div>    <!-- FOOTER -->    <div class="layui-footer" id="footer">        <!-- 底部固定区域 -->        © 2019 行为科技（北京）有限公司    </div></div><script src="/static/js/jquery-3.3.1.min.js"></script><script src="/static/layui/layui.js"></script><script>    var iframeTabs ;    layui.use(['layer','form'], function() {        var layer = layui.layer;        var form = layui.form;        var _tools = {            place: function(title,table,node){                layer.open({                    type: 1,                    title: title,                    area: ['400px','300px'],                    offset: '100px',                    content: $("#view"),                    success: function(index, layero) {                        $("#view").removeClass("layui-hide");                        $.ajax({                            url: "/set/organize/organize_list",                            method: 'post',                            dataType: 'JSON',                            success: function (res) {                                if(res.Code == 1){                                    var data=res.Reason;                                    $("#organize_id").empty();                                    $("#organize_id").append('<option value="">请选择隶属组织</option>');                                    $.each(data, function (index, item) {                                        $("#organize_id").append('<option value="'+item.id+'">'+item.name+'</option>');                                    });                                    if(node){                                        form.val('editcamera', {                                            "organize_id":node.organize_id,                                        });                                    }                                    form.render("select", "editcamera");                                }else{                                    layer.alert(res.Reason);                                }                            },                            error: function (data) {                                layer.alert("服务器连接错误");                            }                        });                    },                    cancel: function(index, layero){                        layer.close(index);                        // hiddenView();                    }                });                form.on('submit(formDemo)', function (data) {                    // layer.alert(JSON.stringify(data.field));                    $.ajax({                        url: '/set/location_add',                        method: 'post',                        data: data.field,                        // dataType: 'JSON',                        success: function (res) {                            // var msg = JSON.parse(res);                            if (res.Ret == 1) {                                layer.alert(res.Reason,function () {                                    layer.closeAll();                                    // $("#myframe")[0].contentWindow.tableReload();                                    table.reload('testReload');                                });                            } else {                                layer.alert(res.Reason);                            }                        },                        error: function (data) {                            layer.alert("服务器连接错误");                        }                    });                    return false;                });            },            // 处置平台删除用户设备            permissionDelete:function(id, table) {                layer.confirm('确认删除该设备?', function(index){                    $.ajax({                        url: '/set/permissions_delete',                        method: 'post',                        data: {                            'userCameraId' : id                        },                        success: function (res) {                            if (res.Code == 0) {                                layer.alert(res.Reason);                                table.reload('cameraTable', {                                    url: '/set/permissions_cameras', //接口地址                                    where: { //设定异步数据接口的额外参数，任意设                                        userId: $("#userId").val()                                    }                                });                            } else {                                layer.alert(res.Reason);                            }                        },                        error: function (data) {                            layer.alert(res.Reason);                        }                    });                    layer.close(index);                });            },            permissionAdd:function(userid, table_) {                layer.open({                    type: 1,                    title: "新增设备",                    area:  ['500px', '400px'],                    content: $("#permissionAddDiv"),                    cancel: function(index, layero){                        layer.close(index);                    }                });                layui.use('table' ,function() {                    var table = layui.table;                    table.render({                        elem: '#cameraUserTable'                        ,method: 'post'                        ,url:'/set/permissions_outcameras'                        ,limit: 5                        ,limits: [5]                        ,cols: [[                            { title: '名称',field:'camera_title',width:'30%'}                            ,{ title: '区域',field:'camera_location',width:'30%'}                            ,{ title: '操作', align: 'center', toolbar: '#camera_bar' }                        ]]                        ,where: {                            userId: userid                        }                        ,page: true                        ,parseData: function (res) { //将原始数据解析成 table 组件所规定的数据                            console.log(res);                            return {                                "code": res.Code, //解析接口状态                                "data": res.Reason, //解析数据列表                                "count":res.Num                            };                        }                    });                    table.on('tool(cameraUserTable)', function (obj) {                        var data = obj.data;                        if (obj.event === 'savePermission') {                            $.ajax({                                url: '/set/permissions_saveUserCameraMap',                                method: 'post',                                data: {                                    'userId' : userid,                                    'cameraId' : data.camera_id                                },                                success: function (res) {                                    if (res.Code == 0) {                                        layer.alert(res.Reason);                                        table.reload('cameraUserTable', {                                            url: '/set/permissions_outcameras', //接口地址                                            where: { //设定异步数据接口的额外参数，任意设                                                userId: $("#userId").val()                                            }                                        });                                        table_.reload('cameraTable', {                                            url: '/set/permissions_cameras', //接口地址                                            where: { //设定异步数据接口的额外参数，任意设                                                userId: $("#userId").val()                                            }                                        });                                    } else {                                        layer.alert(res.Reason);                                    }                                },                                error: function (data) {                                    layer.alert(res.Reason);                                }                            });                            layer.close(index);                        }                    });                });            },            sysAlert:function(msg) {                layer.alert(msg);            },            organizeView:function(title,area,offset,content,code,node) {                layer.open({                    type: 1,                    title: title,                    area: area,                    offset: offset,                    content: content,                    cancel: function(index, layero) {                        layer.close(index);                    },                    success: function(index, lavero) {                        layui.form.render(null, "formOrganize");                        $.ajax({                            url: "/set/organize/organize_list",                            method: 'post',                            data: "",                            dataType: 'JSON',                            success: function (res) {                                if(res.Code == 1){                                    var data=res.Reason;                                    $("#organize_pId").empty();                                    $("#organize_pId").append('<option value="0">请选择隶属组织</option>');                                    $.each(data, function (index, item) {                                        $("#organize_pId").append('<option value="'+item.id+'">'+item.name+'</option>');                                    });                                    if(code == "0"){                                        form.val('formOrganize',{                                            "code":code,                                        });                                    }else {                                        form.val('formOrganize',{                                            "code":code,                                            "organize_id": node.id,                                            "organize_name": node.name,                                            "organize_pId": node.pId,                                            "pname": node.pname,                                            "organize_level": node.level,                                            "phone": node.phone,                                        });                                    }                                    form.render(null, "formOrganize");                                }else{                                    layer.alert(res.Reason);                                }                            },                            error: function (data) {                                layer.alert("服务器连接错误");                            }                        });                        form.render(null, "formOrganize");                    }                });                form.on('submit(organize)', function (data) {                    // layer.alert(JSON.stringify(data.field));                    $.ajax({                        url: '/set/organize/organize_add',                        method: 'post',                        data: data.field,                        success: function (res) {                            layer.alert(res.Reason,function () {                                layer.closeAll();                            });                            $(".layui-tab-item.layui-show").find("iframe")[0].contentWindow.up();                        },                        error: function (data) {                            layer.alert("服务器连接错误");                        }                    });                    return false;                });            },            userView: function (title,area,offset,content,node) {                layer.open({                    type: 1,                    title: title,                    area: area,                    offset: offset,                    content: content,                    cancel: function(index, layero) {                        layer.close(index);                    },                    success: function(index, lavero) {                        $("#member_organizeId").val(node.id);                        form.render(null, "formUser");                    }                });                // form.val('formUser', {                //     "member_organizeId": data.organize_id,                //     "member_name": data.name,                //     "member_user": data.user,                //     "member_pass": data.admin_password,                //     "type":data.type,                // });                form.verify({                    // member_pass:function(value, item) {                        // if(!new RegExp("^(?![a-zA-Z]+$)(?![A-Z0-9]+$)(?![A-Z\\W_!@#$%^&*`~()-+=]+$)(?![a-z0-9]+$)(?![a-z\\W_!@#$%^&*`~()-+=]+$)(?![0-9\\W_!@#$%^&*`~()-+=]+$)[a-zA-Z0-9\\W_!@#$%^&*`~()-+=]{12}$")){                            // layer.alert("平台密码必须强制设置12位，包括大小写字母、数字、特殊符号！");                            // return "平台密码必须强制设置12位，包括大小写字母、数字、特殊符号！";                        // }                    // },                    // member_pass: [/^(?![a-zA-Z]+$)(?![A-Z0-9]+$)(?![A-Z\W_!@#$%^&*`~()-+=]+$)(?![a-z0-9]+$)(?![a-z\W_!@#$%^&*`~()-+=]+$)(?![0-9\W_!@#$%^&*`~()-+=]+$)[a-zA-Z0-9\W_!@#$%^&*`~()-+=]{12}$/,"平台密码必须强制设置12位，包括大小写字母、数字、特殊符号！"]                });                form.on('submit(user)', function (data) {                    // var password = data.field.member_pass;                    // var testPassword =/^(?![a-zA-Z]+$)(?![A-Z0-9]+$)(?![A-Z\W_!@#$%^&*`~()-+=]+$)(?![a-z0-9]+$)(?![a-z\W_!@#$%^&*`~()-+=]+$)(?![0-9\W_!@#$%^&*`~()-+=]+$)[a-zA-Z0-9\W_!@#$%^&*`~()-+=]{12}$/;                    // if(testPassword.test(password)==false){                    //     layer.alert("平台密码必须强制设置12位，包括大小写字母、数字、特殊符号！");                    //     return;                    // }                    $.ajax({                        url: '/set/organize/organize_addMember',                        method: 'post',                        data: data.field,                        dataType: 'JSON',                        success: function (res) {                            if (res.Ret == 1) {                                layer.alert(res.Reason,function () {                                    layer.closeAll();                                    $(".layui-tab-item.layui-show").find("iframe")[0].contentWindow.updateUserList();                                });                            } else {                                layer.alert(res.Reason);                            }                        },                        error: function (data) {                            layer.alert("服务器连接错误");                        }                    });                    return false;                });            }        }        window.tools = _tools;    });    layui.use('element', function() {        var element = layui.element;        //一些事件监听        element.on('nav(test)', function(data) {            if(!$(this)[0].hasAttribute("tab_id") || $(this).attr("tab_id") === '') {                return;            }            var layid = $(this).attr("tab_id");            $("#txt1").val(layid);            var text = $(this).text();            var dataurl = $(this).attr("data-url");            var tabs = $(".layui-tab-title").children();            var msg = true;            $.each(tabs, function(i, item) {                var tabid = $(item).attr("lay-id");                if(tabid === layid) {                    msg = false;                    return false;                }            });            if(msg) {                element.tabAdd('mytab', {                    title: text,                    content: "<iframe id='myframe' frameborder='0' scrolling='no' width='100%' height='100%' src='" + dataurl + "'></iframe>",                    id: layid                });            }            resize();            element.tabChange('mytab', layid);        });        var is1003 = false;        element.on('tab(mytab)',function (data) {            // tabIndex = data.index;            console.log(JSON.stringify(data.elem))            // console.log( "123:"+this.getAttribute("lay-id"));            if( this.getAttribute("lay-id") == "1003"){                if(!is1003){                    is1003=true;                }else{                    console.log( "123:"+this.getAttribute("lay-id"));                    $(".layui-tab-item.layui-show").find("iframe")[0].contentWindow.resizeTable();                }            }        });    });    function resize() {        var $content = $(".layui-tab-content");        $content.height($(this).height() - 200);        $content.find('iframe').each(function() {            $(this).height($content.height());            $(this).width("100%")        })    }    $(window).on('resize', function() {        var $content = $(".layui-tab-content");        $content.height($(this).height() - 200);        $content.find('iframe').each(function() {            $(this).height($content.height());            $(this).width("100%")        });    });    $(window).on('load', function() {        var $content = $(".layui-tab-content");        $content.height($(this).height() - 200);        $content.find('iframe').each(function() {            $(this).height($content.height());            $(this).width("100%")        });    })    function cancel() {        layer.closeAll();    }    function logout(){        layer.confirm('确认退出系统?', function(index){            $.ajax({                url: '/logout',                method: 'post',                data: {},                success: function (res) {                    window.location = "/login";                },                error: function (data) {                    layer.alert("服务器连接错误");                }            });            layer.close(index);        });    }</script></body><div style="width: 100%;height: 100%;background: white;display: none;" id="view">    <form class="layui-form" style="padding: 20px"  lay-filter="editcamera">        <input type="hidden" id="place_id" name="place_id">        <input type="hidden" id="code" value="0" name="code"><!--0注册1修改-->        <div style="width: 100%;height: 38px; line-height: 38px;margin: 0px auto;">            <div class="layui-row">                <div class="layui-col-md4 layui-col-lg4" style="text-align: right;padding-right: 20px;">                    <span>地点名称</span>                </div>                <div class="layui-col-md8 layui-col-lg8">                    <input name="placename" id="placename" class="layui-input" type="text" placeholder="请输入地点名称" lay-verify="required"/>                </div>            </div>        </div>        <div style="width: 100%;height: 38px; line-height: 38px;margin: 10px auto;">            <div class="layui-row">                <div class="layui-col-md4 layui-col-lg4" style="text-align: right;padding-right: 20px;">                    <span>部门</span>                </div>                <div class="layui-col-md8 layui-col-lg8">                    <select id="organize_id" name="organize_id" lay-filter="organize" lay-verify="required">                        <option value="">选择部门</option>                    </select>                </div>            </div>        </div>        <div style="text-align: center;margin:50px;">            <button type="button" class="layui-btn" lay-submit lay-filter="formDemo">保存</button>            <button type="button" class="layui-btn" onclick="cancel()">取消</button>        </div>    </form></div><div style="display:none; width:90%; height:100%; margin: 0 5%; background-color:white;" id="permissionAddDiv">    <table id="cameraUserTable" lay-filter="cameraUserTable" style=""></table>    <input type="hidden" id="user_id"/></div><script type="text/html" id="camera_bar">    <a class="layui-btn layui-btn-primary layui-btn-sm" lay-event="savePermission" style="height: 25px; line-height: 25px;">添加</a></script></html>